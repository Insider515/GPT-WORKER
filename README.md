# GPT-WORKER

## Опис
Воркер служба постановки завдань на обробку в GPT. Отримуючи перелік завдань у вигляді об'єкта воркер ділить їх на запити, які поступово обробляє в GPT.
Для роботи необхідно використовувати мінімум 2 ключа openai API.

### Безпека

Для безпеки системи використовується реєстрація, яка активується/деактивується за допомогою API. Після реєстрації кожному користувачеві при авторизації видається bearer token

## Робота з файлами проекту

### Інсталяція проекту
Проект використовує приватну базу даних sqlite3 (/tmp/db.sqlite3)

Для інсталяції проекту слід виконати
ʼʼʼ
npm install
ʼʼʼ

### Робота з БД
Якщо необхідно інсталюівти бази данних
- Міграція (створення БД та таблиць з полями)
ʼʼʼ
node Ace migration: run
ʼʼʼ
- Відкат (руйнування БД та таблиць з полями)
ʼʼʼ
node Ace migration: rollback
ʼʼʼ
- Сідери (предзаповнення данними)
ʼʼʼ
node Ace db: seed
ʼʼʼ

### Збірка проекту
Для збірки проекту слід виконати команду
ʼʼʼ
node ace build --production
ʼʼʼ

### Запуск проекту
Є 2 режими запуску проекту в тестовому режимі:
1. Звичайний запуск
ʼʼʼ
node ace server
ʼʼʼ
2. Запуск в режимі відстеження змінених зв'язків
ʼʼʼ
node ace serve --watch
ʼʼʼ
## Робота з GPT-WORKER

### Режими роботи
Для передачі даних і отримання відповіді використовується API. Має 2 режими роботи:
1 Повернення відповіді при запиті
2 відправка post запиту в на вказану в конфігураційному файлі адресу (перемикання здійснюється за допомогою API)

### Початок роботи

У данному прикладі для роботи використовуєтся 5 токенів openai API. Для зміни кількості використовуємих ключей вам знадобитьься перейти у файл /app/Controller/GptController.ts та видалити не потрібні записи

ʼʼʼ
private static apiKeys: string[] = [
        process.env.GPT_KEY_0,
        process.env.GPT_KEY_1,
        process.env.GPT_KEY_2,
        process.env.GPT_KEY_3,
        process.env.GPT_KEY_4,
    ];
ʼʼʼ

Також звістно треба буде виконати команду

ʼʼʼ
npm i
ʼʼʼ

## Конфігуційний файл

| Ключ | Тип | Приклад | Опис|
|---|---|---|---|
|PORT|number|PORT=3333|Цей параметр встановлює порт, на якому буде працювати ваш додаток. Значення 3333 вказує на порт 3333.|
|HOST|string|HOST=0.0.0.0|Цей параметр визначає хост (адресу), на якому запуститься додаток. Значення 0.0.0.0 означає, що додаток буде прослуховувати всі доступні мережеві інтерфейси та адреси.|
|NODE_ENV|string|NODE_ENV=development|Цей параметр визначає середовище виконання вашого додатку.    development: Цей режим використовується під час розробки. В ньому зазвичай включені режими налагодження, виведення на консоль помилок та інші інструменти, спрямовані на полегшення розробки.
production: Цей режим використовується в продукційному середовищі. В ньому зазвичай вимкнені режими налагодження та виведення на консоль помилок. Додаток працює в оптимальному режимі для продуктивного використання.
test: Цей режим використовується для запуску автоматичних тестів вашого додатку. В ньому можуть бути встановлені спеціальні налаштування для тестового середовища.|
|APP_KEY|string|APP_KEY=lcLbbK4jePbkwXEnBTHHKINEm8m7nN1i|Цей параметр представляє собою секретний ключ вашого додатку. Він використовується для різних цілей, таких як шифрування даних та забезпечення безпеки.|
|DRIVE_DISK|string|DRIVE_DISK=local|Цей параметр визначає диск (сховище), яке буде використовувати ваш додаток.
local: вказує на локальне сховище.
s3: Цей параметр може вказувати на використання облікових записів Amazon S3 для зберігання файлів у хмарному сховищі Amazon S3. Це корисно, коли потрібно зберігати велику кількість файлів або забезпечити надійність та масштабованість зберігання.
google-cloud: Цей параметр може вказувати на використання Google Cloud Storage для зберігання файлів. Аналогічно до Amazon S3, Google Cloud Storage забезпечує можливість зберігання файлів у хмарному сховищі Google.
azure: Цей параметр може вказувати на використання Azure Blob Storage для зберігання файлів. Azure Blob Storage - це хмарне сховище Microsoft Azure, яке також надає можливості зберігання файлів та даних.
custom: Цей параметр може вказувати на власний кастомний диск або систему зберігання, яку ви налаштовуєте самостійно відповідно до ваших потреб.|
|DB_CONNECTION|string|DB_CONNECTION=sqlite|Цей параметр вказує тип бази даних, який буде використовувати ваш додаток.
sqlite: означає, що буде використовуватися база даних SQLite.
mysql: Цей параметр може вказувати на використання MySQL як системи управління базами даних. MySQL є дуже популярною реляційною базою даних, і вона широко використовується для зберігання та управління даними в багатьох веб-додатках.
pgsql або postgres: Цей параметр може вказувати на використання PostgreSQL
mssql: Цей параметр може вказувати на використання Microsoft SQL Server як СУБД. SQL Server - це продукт Microsoft для управління базами даних.
oracle: Цей параметр може вказувати на використання Oracle Database як СУБД. Oracle - це комерційна база даних, яка часто використовується в корпоративному середовищі.|
|GPT_KEY_0|string|GPT_KEY_0=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|Цей параметр містить ключ API для якоїсь служби або сервісу (в даному випадку, можливо, для GPT - текстової моделі).|
|REQUEST_API|string|REQUEST_API=http://127.0.0.1:3333|Цей параметр представляє собою URL-адресу, яку буде використовувати ваш додаток для відправки HTTP-запитів. Значення http://127.0.0.1:3333 вказує на адресу http://127.0.0.1 і порт 3333.|

Зверніть увагу, що параметри GPT_KEY_0 і REQUEST_API можуть бути унікальними для вашого додатку та залежать від конкретних налаштувань та використовуваних служб.
При наявності декількох API їх треба нумерувати по порядку починаючи з 0

## Робота у продакшен
Для управління додатком використовується менеджер PM2
Основні команди
| Команда | Опис |
|---|---|
|npm install pm2-g|Встановлення PM2 глобально|
|sudo pm2 startup|Включити запуск при завантаженні системи|
|pm2 start app.js|Запуск програми з ім'ям app (або скрипта)|
|pm2 list|Перегляд процесів та їх станів|
|pm2 restart app|Рестарт додатку з назвою app|
|pm2 restart|Рестарт всіх додатків |
|pm2 stop app|Зупинка програми з ім'ям app|
|pm2 stop|Зупинка всіх додатків|
|pm2 delete all|Видалити всі програми зі списку pm2|
|pm2 delete app|Видалити додаток з назвою app|
|pm2 log|Перегляд усіх процессів у режимі реального часу|
|log app|Перегляд дфяльності програми app у режимі реального часу|
|pm2 init|Створення конфігурації|
|pm2 save|Збереження поточного стану до конфігурації|
|pm2 resurrect|Запуск поточних програм з файлу конфігурації|
|pm2 start app.js -i 2|Запуск двох откремих єкземплярів|
|pm2 start ecosystem.config.js|Запуск конфігурації|
|pm2 start ecosystem.config.js --only app|Запуск програми з назвою app зі списку конфігураційного стану|
|pm2 start index.js --max-memory-restart 150M|Обмежити використання оперативної пам'яті|
|pm2 start app.js --watch|Ввімкнення режиму автоматичного перезавантаження програми при зміні якогось файлу (режиму стеження за станом)|
|pm2 stop app --watch|Заміна режиму автоматичного перезавантаження програми при зміні якогось файлу (режиму стеження за станом)|

## API

### Реестрація
| Url | Зміст | Приклад | Відповідь | Помилка |
|---|---|---|---|---|
|/register|http://127.0.0.1:3333/register|{"email": "test@test.com","password": "qwerty123"}|{"user": {"email": "test@test.com","created_at": "2023-09-15T20:42:19.649+02:00","updated_at": "2023-09-15T20:42:19.649+02:00","id": 1},"token": {"type": "bearer","token": "MQ.rc0q7PNkKqwfN3PquRO-wOTFtdWEc4GM5tBCuoWo-Z-b-vKDbj7Zh-65DI6T"}}|Error registration|

### Авторизація
| Url | Зміст | Приклад | Відповідь | Помилка |
|---|---|---|---|---|
|/login|http://127.0.0.1:3333/login|{"email": "test@test.com","password": "qwerty123"}|"token": {"type": "bearer","token": "MQ.rc0q7PNkKqwfN3PquRO-wOTFtdWEc4GM5tBCuoWo-Z-b-vKDbj7Zh-65DI6T"}}|Invalid credentials|

### Запит на обробку
| Url | Зміст | Приклад | Відповідь | Помилка |
|---|---|---|---|---|
|/login|http://127.0.0.1:3333/login|{"settings": {"maxTokenCount": 4000,"gpt_type": "gpt-4","temperature": 1},"data": { "1": "Переведи на украинский язык \n The database table to use for storing the tokens. During the initial setup process, TS will create the migration file for the tokens table. However, you can also create a migration manually and copy the contents from the stub file.", "2": "Переведи на украинский язык \n The SQL storage method is suitable when API tokens are not the primary mode of authentication. For example: You may want to allow the users of your application to create personal access tokens (just like the way GitHub does) and authenticate the API requests using that."}}|{"message": "Завдання створено успішно","date": "2023-09-16T08:19:43.975Z"} або { "1": "Таблиця бази даних для зберігання токенів. Під час початкового процесу налаштування, TypeScript (TS) створить файл міграції для таблиці токенів. Однак ви також можете створити міграцію вручну і скопіювати вміст із файлу-заготовки.", "2": "Метод зберігання SQL підходить, коли токени API не є основним способом автентифікації. Наприклад: ви можете бажати дозволити користувачам вашого додатка створювати особисті токени доступу (аналогічно тому, як це робить GitHub) і аутентифікувати запити до API за допомогою цих токенів."}}|Invalid credentials|
